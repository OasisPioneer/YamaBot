#include "InstructionSet.HPP"
#include <regex>
#include <cstdio>
#include <iostream>
#include <curl/curl.h>
#include <nlohmann/json.hpp>

using json = nlohmann::json;

// CURL å›è°ƒå‡½æ•°ï¼šå°†å“åº”å†™å…¥ std::string
static size_t WriteCallback(void *contents, size_t size, size_t nmemb, void *userp)
{
    ((std::string *)userp)->append((char *)contents, size * nmemb);
    return size * nmemb;
}

std::string Ping(std::string &Parameter)
{
    // ä¼˜å…ˆåˆ¤æ–­ç©ºå­—ç¬¦ä¸²
    // å¤„ç† /ping å‘½ä»¤
    if (Parameter.empty())
    {
        return "ä½ è¦ Ping è°ï¼Ÿ";
    }
    std::string summary;
    // ä½¿ç”¨æ­£åˆ™åˆ¤æ–­æ˜¯å¦åˆæ³•
    std::regex ValidPattern(R"(^[a-zA-Z0-9\.\-]+$)");
    if (!std::regex_match(Parameter, ValidPattern))
    {
        return "éæ³•ç›®æ ‡åœ°å€";
    }
    std::string Result;
    std::string CMD = "ping -c 1 " + Parameter + " 2>&1";
    FILE *Pipe = popen(CMD.c_str(), "r");
    if (!Pipe)
    {
        return "Ping å‘½ä»¤æ‰§è¡Œå¤±è´¥";
    }
    char Buffer[256];
    while (fgets(Buffer, sizeof(Buffer), Pipe) != nullptr)
    {
        Result += Buffer;
    }
    pclose(Pipe);

    std::istringstream iss(Result);
    std::string line;
    while (std::getline(iss, line))
    {
        if (line.find("bytes from") != std::string::npos ||  // å“åº”è¡Œ
            line.find("packet loss") != std::string::npos || // ä¸¢åŒ…è¡Œ
            line.find("rtt ") != std::string::npos)          // RTT è¡Œ
        {
            summary += line + "\n";
        }
    }
    if (summary.empty())
        summary = "ç›®æ ‡ä¸å¯è¾¾æˆ–æ— è¿”å›ã€‚";
    return summary;
}

std::string Whois(std::string &Parameter)
{
    // ä¼˜å…ˆåˆ¤æ–­ç©ºå­—ç¬¦ä¸²
    if (Parameter.empty())
    {
        return "ä½ è¦ Whois è°ï¼Ÿ";
    }

    // ä½¿ç”¨æ­£åˆ™åˆ¤æ–­æ˜¯å¦åˆæ³•
    std::regex ValidPattern(R"(^[a-zA-Z0-9\.\-]+$)");
    if (!std::regex_match(Parameter, ValidPattern))
    {
        return "éæ³•ç›®æ ‡åœ°å€";
    }

    // æ„å»ºå¹¶æ‰§è¡Œ whois å‘½ä»¤
    std::string Result;
    std::string CMD = "whois " + Parameter + " 2>&1";
    FILE *Pipe = popen(CMD.c_str(), "r");
    if (!Pipe)
    {
        return "Whois å‘½ä»¤æ‰§è¡Œå¤±è´¥";
    }

    // é€è¡Œè¯»å–è¾“å‡º
    char Buffer[2048];
    while (fgets(Buffer, sizeof(Buffer), Pipe) != nullptr)
    {
        Result += Buffer;
    }
    pclose(Pipe);

    if (Result.empty())
    {
        return "æ²¡æœ‰è¿”å›ä»»ä½• Whois æ•°æ®ï¼Œå¯èƒ½ç›®æ ‡ä¸å­˜åœ¨æˆ–è¢«é™åˆ¶è®¿é—®";
    }
    std::istringstream Stream(Result);
    std::string Line, Filtered;
    std::vector<std::string> Keywords = {
        "Domain Name:", "Registrar:", "Creation Date:", "Registry Expiry Date:",
        "Name Server:", "Updated Date:"};

    while (std::getline(Stream, Line))
    {
        for (const auto &Key : Keywords)
        {
            if (Line.find(Key) != std::string::npos)
            {
                Filtered += Line + "\n";
                break;
            }
        }
    }
    return Filtered.empty() ? "æœªæ‰¾åˆ°å…³é”®ä¿¡æ¯" : Filtered;
}
std::string QueryQQ(std::string &Parameter)
{
    CURL *URL;
    CURLcode Res;
    std::string ReadBuffer;

    URL = curl_easy_init();
    if (!URL)
        return "QQ æŸ¥è¯¢å¤±è´¥";

    std::string URLString = "https://www.xywlapi.cc/qqcx2023?qq=" + Parameter;
    curl_easy_setopt(URL, CURLOPT_URL, URLString.c_str());
    curl_easy_setopt(URL, CURLOPT_WRITEFUNCTION, WriteCallback);
    curl_easy_setopt(URL, CURLOPT_WRITEDATA, &ReadBuffer);

    // SSL è®¾ç½®
    curl_easy_setopt(URL, CURLOPT_SSL_VERIFYPEER, 1L);
    curl_easy_setopt(URL, CURLOPT_SSL_VERIFYHOST, 2L);

    Res = curl_easy_perform(URL);
    curl_easy_cleanup(URL);
    if (Res != CURLE_OK)
        return "æŸ¥è¯¢å¤±è´¥ï¼Œç–‘ä¼¼æ¥å£å®æ•ˆï¼Œè¯·è”ç³»ç®¡ç†å‘˜ï¼";
    json Json;
    try
    {
        Json = json::parse(ReadBuffer);
    }
    catch (const std::exception &e)
    {
        std::cerr << "JSON è§£æé”™è¯¯: " << e.what() << "\nåŸå§‹å“åº”: " << ReadBuffer << std::endl;
        return "æŸ¥è¯¢å¤±è´¥ï¼Œç–‘ä¼¼æ¥å£è¿”å›å¼‚å¸¸æ•°æ®ï¼";
    }

    if (!Json.contains("status") || !Json["status"].is_number_integer() || Json["status"].get<int>() != 200)
        return "æŸ¥è¯¢å¤±è´¥ï¼Œæ¥å£è¿”å›çŠ¶æ€å¼‚å¸¸ï¼";

    if (!Json.contains("message") || Json["message"].get<std::string>() != "æŸ¥è¯¢æˆåŠŸ")
        return "æŸ¥è¯¢å¤±è´¥ï¼Œè¯¥ä¿¡æ¯ä¸å­˜åœ¨äºæ•°æ®åº“ä¸­ï¼";

    // æå–æœ‰æ•ˆå­—æ®µ
    std::string Phone = Json.value("phone", "æœªçŸ¥");
    std::string Diqu = Json.value("phonediqu", "æœªçŸ¥");
    std::string Qqlm = Json.value("qqlm", "æ— ");

    std::ostringstream Oss;
    Oss << "ğŸ“±æ‰‹æœºå·: " << Phone << "\n"
        << "ğŸ“å½’å±åœ°: " << Diqu << "\n"
        << "ğŸ”—QQè€å¯†: " << (Qqlm != "æ²¡æœ‰æ‰¾åˆ°" ? Qqlm : "æœªæ‰¾åˆ°") << "\n";

    return Oss.str();
}